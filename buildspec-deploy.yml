version: 0.2
phases:
  install:
    commands:
      - echo "Preparando deploy..."
  build:
    commands:
      - echo "Copiando artifact a /tmp/app"
      - mkdir -p /tmp/app
      - cp $CODEBUILD_SRC_DIR/app.zip /tmp/app/app.zip
      - unzip -o /tmp/app/app.zip -d /tmp/app/
      - test -f /tmp/app/index.html || exit 1
  post_build:
    commands:
      - echo "Aplicando deploy via SSM"
      - |
        aws ssm send-command \
          --instance-ids $INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --comment "Desplegando web" \
          --parameters 'commands=[
            "sudo cp -r /tmp/app/* /var/www/html/",
            "sudo chown -R www-data:www-data /var/www/html || true",
            "if sudo systemctl is-active apache2 >/dev/null 2>&1; then sudo systemctl restart apache2; elif sudo systemctl is-active httpd >/dev/null 2>&1; then sudo systemctl restart httpd; fi"
          ]' \
          --timeout-seconds 600
